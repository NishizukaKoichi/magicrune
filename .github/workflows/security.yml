name: Security
on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  audit_and_deny:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      - uses: dtolnay/rust-toolchain@7b1c307e0dcbda6122208f10795a713336a9b35a
        with:
          toolchain: 1.82.0
      - uses: Swatinem/rust-cache@82a92a6e8fbeee089604da2575dc567ae9ddeaab # v2.7.5
      - name: Install cargo-binstall
        run: |
          curl -L --retry 5 --retry-delay 1 https://github.com/cargo-bins/cargo-binstall/releases/latest/download/cargo-binstall-x86_64-unknown-linux-musl.tgz | tar xvz -C ~/.cargo/bin
          
      - name: Install security tools
        run: |
          cargo binstall --no-confirm --no-symlinks cargo-audit --version 0.21.0
          cargo binstall --no-confirm --no-symlinks cargo-deny --version 0.16.3
      - name: Create Cargo.lock if missing
        run: |
          if [ ! -f Cargo.lock ]; then
            cargo generate-lockfile
          fi
      # Use committed Cargo.lock for reproducible audit
      - name: Install latest cargo-audit
        run: cargo install cargo-audit --locked --force
      - name: cargo audit (no inline ignore)
        run: cargo audit --locked --color always
      - name: cargo deny
        run: cargo deny check advisories licenses bans sources
  
  gitleaks:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0
      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: --redact --config .gitleaks.toml --no-git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
